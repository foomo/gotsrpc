# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**gotsrpc** is a code generator that produces type-safe RPC bindings between Go services and TypeScript clients, with optional Go-to-Go RPC support. It parses Go source code via AST, reads a YAML config (`gotsrpc.yml`), and generates:
- Go HTTP service proxies (`gotsrpc_gen.go`) and clients (`gotsrpcclient_gen.go`)
- Go binary protocol proxies (`gorpc_gen.go`) and clients (`gorpcclient_gen.go`)
- TypeScript client classes and type definitions

## Common Commands

```bash
make build           # Build CLI binary to bin/gotsrpc
make test            # Run all tests (all modules, race detector, -tags=safe)
make lint            # Run golangci-lint across all modules
make lint.fix        # Auto-fix lint violations
make tidy            # Run go mod tidy across all modules
make check           # Run tidy + examples + lint + test
make examples        # Generate all example code
make example.basic   # Generate a specific example (basic, errors, monitor, nullable, union, time)
```

Run a single test:
```bash
cd example && go test -run TestFunctionName ./...
```

Tests use build tag `-tags=safe` and the `testify` assertion library.

## Architecture

### Code Generation Pipeline

1. **CLI entry point** (`cmd/gotsrpc/gotsrpc.go`) loads `gotsrpc.yml` via `config.LoadConfigFile()`, then calls `gotsrpc.Build()`
2. **Build orchestrator** (`build.go`) iterates targets and mappings, coordinating type reading and code output
3. **AST readers** parse Go source to extract service definitions and types:
   - `servicereader.go` — reads service interfaces/structs and their methods
   - `typereader.go` — reads struct fields, scalars, enums, and type relationships
4. **Code generators** produce output:
   - `go.go` — Go proxy/client code (HTTP and gorpc)
   - `typescript.go` + `typescriptclient.go` — TypeScript types and client classes
   - `gorpc.go` — Go binary RPC protocol support
5. **Type model** (`model.go`) defines the intermediate representation: `Service`, `Method`, `Field`, `Value`, `Struct`, `Type`

### Runtime Libraries (used by generated code)

- `transport.go`, `transportjson.go`, `transportmsgpack.go` — serialization (msgpack + JSON)
- `client.go` — HTTP RPC client implementation
- `gotsrpc.go` — core handler/proxy utilities
- `error.go` — error serialization with cause chains
- `stats.go` — call performance metrics (marshalling, execution, sizes)
- `instrumentation.go` — middleware hooks
- `prometheus/` — Prometheus metrics integration

### Configuration Format (`gotsrpc.yml`)

```yaml
module:
  name: github.com/foomo/gotsrpc/v2   # Go module name
  path: ../../                          # Relative path to module root

targets:
  targetName:
    services:
      /endpoint: ServiceName            # HTTP path -> Go service
    package: github.com/foomo/gotsrpc/v2/example/basic/service
    out: ./client/src/service-client.ts  # TypeScript client output
    gorpc: [ServiceName]                 # Enable Go binary RPC
    tsrpc: [ServiceName]                 # Enable TypeScript RPC
    skipTSRPCClient: false               # Skip TS client generation

mappings:
  github.com/foomo/gotsrpc/v2/example/basic/service:
    out: ./client/src/service-vo.ts      # TypeScript type definitions
```

## Project Layout

- Root package (`github.com/foomo/gotsrpc/v2`) — generator + runtime library in one module
- `cmd/gotsrpc/` — CLI binary
- `config/` — YAML config loading and schema
- `example/` — separate Go module (`go.work` workspace) with sub-examples (basic, errors, etc.)
- `tests/` — integration tests with Go + TypeScript clients
- `prometheus/` — Prometheus instrumentation sub-package
- Generated files are suffixed `_gen.go` and marked with `// Code generated by gotsrpc`

## Conventions

- Uses Go workspaces (`go.work`) with two modules: root (`.`) and `./example`
- Commit messages follow [Conventional Commits](https://www.conventionalcommits.org/) (`feat:`, `fix:`, `docs:`, etc.)
- Linting uses golangci-lint v2 config (`.golangci.yaml`) with `default: all` and many disabled checks
- Tooling managed via [mise](https://mise.jdx.dev): bun, golangci-lint, husky
- CI runs: `make tidy` (with `git diff --exit-code`), `make lint`, `make test`, `make examples` (with `git diff --exit-code`)
